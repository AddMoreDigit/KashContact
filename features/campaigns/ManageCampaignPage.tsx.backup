import { useState } from 'react';
import { ChevronLeft, Edit, Star, Plus, X } from 'lucide-react@0.487.0';
import { Button } from '../../components/ui/button';
import { Input } from '../../components/ui/input';
import { Progress } from '../../components/ui/progress';
import { Avatar, AvatarFallback } from '../../components/ui/avatar';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '../../components/ui/dialog';
import { Label } from '../../components/ui/label';
import { ImageWithFallback } from '../../components/figma/ImageWithFallback';
import { toast } from 'sonner@2.0.3';

            param($match)
            $importPath = $match.Groups[1].Value
            # Ensure the path is properly quoted
            "import '$importPath';"
        ;
import { getCampaignById, isCampaignAdmin } from '../../utils/campaignStorage';
import { getCampaignContributions, getCampaignTotalContributed } from '../../utils/contributionStorage';

type Page = 'dashboard' | 'campaigns' | 'vouchers' | 'transactions' | 'profile' | 'overview' | 'draft' | 'howItWorks' | 'campaignDetail' | 'messaging' | 'serviceDetail' | 'selectedServices' | 'createCampaign' | 'manageCampaign' | 'contributors' | 'contributorDetail';

interface Member {
  email: string;
  name?: string;
  avatar?: string;
  contributionPercentage?: number;
  contributedAmount?: number;
  goalAmount?: number;
  daysLeft?: number;
  missedPayments?: number;
  status?: 'up-to-date' | 'pending' | 'on-track' | 'completed' | 'critical';
}

interface CartItem {
  id: number;
  type: 'room' | 'food' | 'transport' | 'activity';
  name: string;
  price: string;
  provider?: string;
  image?: string;
  totalPrice?: number;
}

interface Campaign {
  id: number;
  title: string;
  image: string;
  provider: string;
  date: string;
  services: { name: string; type: string }[];
  members: { email: string; name?: string; contributionPercentage?: number; contributedAmount?: number; status?: 'up-to-date' | 'pending' }[];
  memberPerformance?: Member[];
  goal: number;
  contributed: number;
  status: 'contribute' | 'manage';
  category?: string;
  startDate: string;
  endDate: string;
  contributionFrequency?: string;
  cartItems?: CartItem[];
}

interface ManageCampaignPageProps {
  onNavigate: (page: Page) => void;
  campaign?: Campaign | null;
  onUpdateCampaign?: (campaign: Campaign) => void;
  onBack?: () => void;
}

export function ManageCampaignPage({ onNavigate, campaign, onUpdateCampaign, onBack }: ManageCampaignPageProps) {
  const [inviteEmail, setInviteEmail] = useState('');
  const [isPaused, setIsPaused] = useState(false);
  const [addContributionDialog, setAddContributionDialog] = useState(false);
  const [selectedMemberEmail, setSelectedMemberEmail] = useState('');
  const [contributionAmount, setContributionAmount] = useState('');
  
  // Get current user email and check admin status
  const currentUserEmail = localStorage.getItem('userEmail') || 'michael@example.com';
  
  // Check if current user is an admin (for real campaigns from storage)
  const checkIsAdmin = (): boolean => {
    if (!campaign || !campaign.id) return true; // Default campaign - allow management
    
    try {
      const storedCampaign = getCampaignById(campaign.id.toString());
      if (storedCampaign && storedCampaign.adminEmails) {
        return isCampaignAdmin(storedCampaign, currentUserEmail);
      }
    } catch (error) {
      console.error('Error checking admin status:', error);
    }
    
    return true; // Default to allowing access for non-stored campaigns
  };
  
  const isUserAdmin = checkIsAdmin();

  // Default campaign if none provided
  const defaultCampaign: Campaign = {
    id: 1,
    title: 'Cape Town Gateway Weekend',
    image: campaignHeroImg,
    provider: 'Seaview Lodge',
    date: 'Sep 1 â†’ Dec 5, 2025',
    startDate: '2025-09-01',
    endDate: '2025-12-05',
    services: [
      { name: 'Seaview Lodge', type: 'Accommodation' },
      { name: 'TasteBites Catering', type: 'Food' },
    ],
    members: [
      { email: 'alice@example.com', contributionPercentage: 75, contributedAmount: 6000, status: 'up-to-date' },
      { email: 'john@example.com', contributionPercentage: 100, contributedAmount: 3000, status: 'up-to-date' },
      { email: 'jonathan@example.com', contributionPercentage: 0, contributedAmount: 0, status: 'pending' },
    ],
    goal: 20000,
    contributed: 9000,
    status: 'manage',
  };

  const activeCampaign = campaign || defaultCampaign;
  const progressPercent = Math.round(((activeCampaign.contributed || 0) / (activeCampaign.goal || 1)) * 100);

  // Use memberPerformance if available, otherwise use members
  const displayMembers: Member[] = activeCampaign.memberPerformance && activeCampaign.memberPerformance.length > 0
    ? activeCampaign.memberPerformance.map(mp => ({
        ...mp,
        status: mp.status === 'completed' ? 'up-to-date' as const : 
                mp.status === 'on-track' || mp.status === 'critical' ? 'pending' as const :
                mp.status as 'up-to-date' | 'pending'
      }))
    : (activeCampaign.members as Member[]);

  const getMemberInitials = (email: string) => {
    return email.substring(0, 2).toUpperCase();
  };

  const getMemberName = (email: string) => {
    return email.split('@')[0].charAt(0).toUpperCase() + email.split('@')[0].slice(1);
  };

  const handleInvite = () => {
    if (!inviteEmail.trim()) {
      toast.error('Please enter an email address');
      return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inviteEmail)) {
      toast.error('Please enter a valid email address');
      return;
    }

    const updatedCampaign = {
      ...activeCampaign,
      members: [
        ...activeCampaign.members,
        { email: inviteEmail, contributionPercentage: 0, contributedAmount: 0, status: 'pending' as const }
      ]
    };

    onUpdateCampaign?.(updatedCampaign);
    toast.success(`Invitation sent to ${inviteEmail}`);
    setInviteEmail('');
  };

  const handleAddContribution = (memberEmail: string) => {
    setSelectedMemberEmail(memberEmail);
    setContributionAmount('');
    setAddContributionDialog(true);
  };

  const handleSaveContribution = () => {
    const amount = parseFloat(contributionAmount);
    if (isNaN(amount) || amount <= 0) {
      toast.error('Please enter a valid amount');
      return;
    }

    const member = activeCampaign.members.find(m => m.email === selectedMemberEmail);
    if (!member) return;

    const currentContributed = member.contributedAmount || 0;
    const newContributed = currentContributed + amount;
    const memberShare = activeCampaign.goal / activeCampaign.members.length;
    const newPercentage = Math.min(100, Math.round((newContributed / memberShare) * 100));

    const updatedCampaign = {
      ...activeCampaign,
      members: activeCampaign.members.map(m =>
        m.email === selectedMemberEmail
          ? {
              ...m,
              contributedAmount: newContributed,
              contributionPercentage: newPercentage,
              status: newPercentage >= 100 ? 'up-to-date' as const : 'pending' as const
            }
          : m
      ),
      contributed: activeCampaign.contributed + amount
    };

    onUpdateCampaign?.(updatedCampaign);
    setAddContributionDialog(false);
    toast.success(`Contribution of R${amount.toLocaleString()}.00 added`);
  };

  const handlePauseCampaign = () => {
    setIsPaused(!isPaused);
    if (!isPaused) {
      toast.success('Campaign paused');
    } else {
      toast.success('Campaign resumed');
    }
  };

  const renderStars = (rating: number) => {
    return (
      <div className="flex gap-0.5">
        {[...Array(5)].map((_, i) => (
          <Star
            key={i}
            className={`w-3 h-3 ${
              i < Math.floor(rating)
                ? 'fill-amber-400 text-amber-400'
                : 'fill-gray-300 text-gray-300'
            }`}
          />
        ))}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Hero Section */}
      <div className="relative w-full h-64">
        <ImageWithFallback
          src={activeCampaign.image}
          alt="Campaign hero"
          className="w-full h-full object-cover"
        />
      </div>

      {/* Main Content */}
      <div className="max-w-5xl mx-auto px-8 py-8">
        {/* Campaign Title */}
        <div className="bg-white rounded-lg p-6 mb-6">
          <h1 className="text-gray-900 text-2xl mb-2">{activeCampaign.title}</h1>
          <p className="text-gray-600">{activeCampaign.category || 'Group Campaign'}</p>
        </div>

        {/* Service Provider Section */}
        <div className="bg-white rounded-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-gray-900">Service Provider</h2>
            <Button variant="ghost" size="sm" className="text-purple-600 hover:text-purple-700">
              <Edit className="w-4 h-4 mr-2" />
              Edit
            </Button>
          </div>

          <div className="grid grid-cols-2 gap-4">
            {activeCampaign.services.map((service, index) => (
              <div key={index} className="flex items-center gap-3">
                <div className="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0 bg-gray-200 flex items-center justify-center">
                  {activeCampaign.cartItems?.[index]?.image ? (
                    <ImageWithFallback
                      src={activeCampaign.cartItems[index].image!}
                      alt={service.name}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <span className="text-gray-600">{service.name.charAt(0)}</span>
                  )}
                </div>
                <div>
                  <div className="text-gray-900 mb-1">{service.name}</div>
                  <div className="flex items-center gap-1 text-sm text-gray-600">
                    {renderStars(4)}
                    <span className="text-gray-400">(24 Reviews)</span>
                  </div>
                  <p className="text-xs text-gray-500">{service.type}</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Campaign Goal Section */}
        <div className="bg-white rounded-lg p-6 mb-6">
          <h2 className="text-gray-900 mb-6">Campaign Goal</h2>

          <div className="flex items-start justify-between mb-4">
            <div>
              <div className="flex items-center gap-2 text-gray-700 mb-1">
                <span className="w-3 h-3 rounded-full bg-purple-600"></span>
                <span>Goal: R{(activeCampaign.goal || 0).toLocaleString()}.00</span>
              </div>
              <div className="flex items-center gap-2 text-sm text-gray-600">
                <span>ðŸ“… {activeCampaign.date}</span>
              </div>
            </div>
            <div className="text-right">
              <div className="text-gray-900 mb-1">Contributed: R{(activeCampaign.contributed || 0).toLocaleString()}.00</div>
              <div className="text-purple-600">{progressPercent}%</div>
            </div>
          </div>

          <Progress value={progressPercent} className="h-2 mb-2" />
        </div>

        {/* Members Section */}
        <div className="bg-white rounded-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-gray-900">Members</h2>
            <Button 
              className="bg-purple-600 hover:bg-purple-700 text-white"
              onClick={() => onNavigate('contributors')}
            >
              Campaign performance
            </Button>
          </div>

          {/* Summary Stats */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div>
              <div className="text-sm text-gray-600 mb-1">Total Campaign Goal</div>
              <div className="text-gray-900">R{(activeCampaign.goal || 0).toLocaleString()}</div>
            </div>
            <div>
              <div className="text-sm text-gray-600 mb-1">Members</div>
              <div className="text-gray-900">{displayMembers.length}</div>
            </div>
            <div>
              <div className="text-sm text-gray-600 mb-1">Target per Member</div>
              <div className="text-gray-900">R{((activeCampaign.goal || 0) / Math.max(displayMembers.length, 1)).toLocaleString()}</div>
            </div>
            <div>
              <div className="text-sm text-gray-600 mb-1">Total Member Targets</div>
              <div className="text-purple-600">R{(activeCampaign.goal || 0).toLocaleString()}</div>
            </div>
          </div>

          <div className="space-y-4">
            {displayMembers.map((member, index) => (
              <div key={index} className="flex items-center gap-4">
                <Avatar className="w-10 h-10">
                  <AvatarFallback className="bg-purple-500 text-white">
                    {member.name ? member.name.charAt(0).toUpperCase() : getMemberInitials(member.email)}
                  </AvatarFallback>
                </Avatar>
                <div className="flex-1">
                  <div className="flex items-center justify-between mb-2">
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="text-gray-900">{member.name || getMemberName(member.email)}</span>
                        {(() => {
                          try {
                            const storedCampaign = getCampaignById(campaign?.id?.toString() || '');
                            if (storedCampaign && storedCampaign.adminEmails) {
                              const isAdmin = storedCampaign.adminEmails.includes(member.email);
                              const isCreator = storedCampaign.creatorEmail === member.email;
                              if (isCreator) {
                                return <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">Creator</span>;
                              } else if (isAdmin) {
                                return <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">Co-Admin</span>;
                              }
                            }
                          } catch (error) {
                            // Ignore errors
                          }
                          return null;
                        })()}
                      </div>
                      <div className="text-xs text-gray-500">
                        {member.status === 'up-to-date' || member.status === 'completed' ? 'Up to date' : 'Pending'} â€¢ Target: R{Math.round(member.goalAmount || (activeCampaign.goal / displayMembers.length)).toLocaleString()} â€¢ Contributed: R{Math.round(member.contributedAmount || 0).toLocaleString()}
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="text-gray-700">{member.contributionPercentage || 0}%</span>
                      {isUserAdmin && (
                        <Button
                          variant="ghost"
                          size="sm"
                          className="text-purple-600"
                          onClick={() => handleAddContribution(member.email)}
                        >
                          Edit
                        </Button>
                      )}
                    </div>
                  </div>
                  <Progress value={member.contributionPercentage || 0} className="h-2" />
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Invites Members Section - Admin Only */}
        {isUserAdmin && (
          <div className="bg-white rounded-lg p-6 mb-6">
            <h2 className="text-gray-900 mb-4">Invites Members</h2>

            <div className="flex gap-3">
              <Input
                placeholder="Search by Username or email"
                value={inviteEmail}
                onChange={(e) => setInviteEmail(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    handleInvite();
                  }
                }}
                className="flex-1"
              />
              <Button 
                className="bg-purple-600 hover:bg-purple-700"
                onClick={handleInvite}
              >
                Invite
              </Button>
            </div>
          </div>
        )}

        {/* Non-Admin Message */}
        {!isUserAdmin && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h3 className="text-gray-900 mb-2">Member View</h3>
            <p className="text-gray-600 text-sm">
              You are viewing this campaign as a member. Only campaign admins can edit details, invite members, and manage the campaign.
            </p>
          </div>
        )}

        {/* Action Buttons */}
        <div className="flex items-center gap-4">
          <Button
            variant="outline"
            onClick={() => onNavigate('campaigns')}
            className="border-gray-300"
          >
            <ChevronLeft className="w-4 h-4 mr-2" />
            Back
          </Button>
          {isUserAdmin && (
            <Button
              onClick={handlePauseCampaign}
              className={`${
                isPaused 
                  ? 'bg-green-600 hover:bg-green-700' 
                  : 'bg-purple-600 hover:bg-purple-700'
              } text-white`}
            >
              {isPaused ? 'Resume Campaign' : 'Pause Campaign'}
            </Button>
          )}
        </div>
      </div>

      {/* Add Contribution Dialog */}
      <Dialog open={addContributionDialog} onOpenChange={setAddContributionDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Add Contribution</DialogTitle>
            <DialogDescription>
              Add a contribution amount for the selected member.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div>
              <Label>Member</Label>
              <Input value={getMemberName(selectedMemberEmail)} disabled className="bg-gray-50" />
            </div>
            <div>
              <Label htmlFor="amount">Contribution Amount (R)</Label>
              <Input
                id="amount"
                type="number"
                min="0"
                step="0.01"
                value={contributionAmount}
                onChange={(e) => setContributionAmount(e.target.value)}
                placeholder="0.00"
              />
            </div>
            <div className="text-sm text-gray-600">
              <p>Current: R{(activeCampaign.members.find(m => m.email === selectedMemberEmail)?.contributedAmount || 0).toLocaleString()}.00</p>
              <p>Goal Share: R{(activeCampaign.goal / activeCampaign.members.length).toLocaleString()}.00</p>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setAddContributionDialog(false)}>
              Cancel
            </Button>
            <Button onClick={handleSaveContribution} className="bg-purple-600 hover:bg-purple-700">
              Add Contribution
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


